<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Cloud Provider Azure â€“ Design Docs and KEPs</title><link>https://kubernetes-sigs.github.io/cloud-provider-azure/development/design-docs/</link><description>Recent content in Design Docs and KEPs on Cloud Provider Azure</description><generator>Hugo -- gohugo.io</generator><atom:link href="https://kubernetes-sigs.github.io/cloud-provider-azure/development/design-docs/index.xml" rel="self" type="application/rss+xml"/><item><title>Development: Out-of-tree Node IPAM Controller</title><link>https://kubernetes-sigs.github.io/cloud-provider-azure/development/design-docs/ipam/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://kubernetes-sigs.github.io/cloud-provider-azure/development/design-docs/ipam/</guid><description>
&lt;h2 id="background">Background&lt;/h2>
&lt;p>The in-tree &lt;a href="https://github.com/kubernetes/kubernetes/tree/master/pkg/controller/nodeipam">Node IPAM controller&lt;/a> only supports a fixed node CIDR mask size for all nodes, while in multiple node pool (VMSS) scenarios, different mask sizes are required for different node pools. There is a GCE-specific cloud CIDR allocator for a similar scenario, but that is not exposed in cloud provider API and it is planned to be moved out-of-tree.&lt;/p>
&lt;p>Hence this docs proposes an out-of-tree node IPAM controller. Specifically, allocate different pod CIDRs based on different CIDR mask size for different node pools (VMSS or VMAS).&lt;/p>
&lt;h2 id="user-experience">User experience&lt;/h2>
&lt;p>There are two kinds of CIDR allocator in the node IPAM controller, which are &lt;code>RangeAllocator&lt;/code> and &lt;code>CloudAllocator&lt;/code>.
The &lt;code>RangeAllocator&lt;/code> is the default one which allocates the pod CIDR for every node in the range of the cluster CIDR.
The &lt;code>CloudAllocator&lt;/code> allocates the pod CIDR for every node in the range of the CIDR on the corresponding VMSS or VMAS.&lt;/p>
&lt;p>The CIDR on the VMSS or VMAS is set by a specific tag &lt;code>{&amp;quot;kubernetesNodeCIDRMaskSize&amp;quot;: &amp;quot;24&amp;quot;}&lt;/code> and every node would get a
pod CIDR within the range. Note that the mask size in the VMSS or VMAS must be within the cluster CIDR, or an error would be
thrown.&lt;/p>
&lt;p>When the above tag doesn't exist on VMSS/VMAS, the values from &lt;code>--node-cidr-mask-size&lt;/code> would be used as default mask size.&lt;/p>
&lt;h2 id="configurations">Configurations&lt;/h2>
&lt;h3 id="kube-controller-manager">kube-controller-manager&lt;/h3>
&lt;p>kube-controller-manager would be configured with option &lt;code>--allocate-node-cidrs=false&lt;/code> to indicate it won't allocate Node CIDRs.&lt;/p>
&lt;h3 id="cloud-controller-manager">cloud-controller-manager&lt;/h3>
&lt;p>The following configurations from cloud-controller-manager would be used as default options:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>name&lt;/th>
&lt;th>type&lt;/th>
&lt;th>default&lt;/th>
&lt;th>description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>allocate-node-cidrs&lt;/td>
&lt;td>bool&lt;/td>
&lt;td>true&lt;/td>
&lt;td>Should CIDRs for Pods be allocated and set on the cloud provider.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cluster-cidr&lt;/td>
&lt;td>string&lt;/td>
&lt;td>&amp;ldquo;10.244.0.0/16&amp;rdquo;&lt;/td>
&lt;td>CIDR Range for Pods in cluster. Requires &amp;ndash;allocate-node-cidrs to be true&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>service-cluster-ip-range&lt;/td>
&lt;td>string&lt;/td>
&lt;td>&amp;quot;&amp;rdquo;&lt;/td>
&lt;td>CIDR Range for Services in cluster. Requires &amp;ndash;allocate-node-cidrs to be true&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>node-cidr-mask-size&lt;/td>
&lt;td>int&lt;/td>
&lt;td>24&lt;/td>
&lt;td>Mask size for node cidr in cluster. Default is 24 for IPv4 and 64 for IPv6.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>node-cidr-mask-size-ipv4&lt;/td>
&lt;td>int&lt;/td>
&lt;td>24&lt;/td>
&lt;td>Mask size for IPv4 node cidr in dual-stack cluster. Default is 24.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>node-cidr-mask-size-ipv6&lt;/td>
&lt;td>int&lt;/td>
&lt;td>64&lt;/td>
&lt;td>Mask size for IPv6 node cidr in dual-stack cluster. Default is 64.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>cidr-allocator-type&lt;/td>
&lt;td>string&lt;/td>
&lt;td>&amp;ldquo;RangeAllocator&amp;rdquo;&lt;/td>
&lt;td>The CIDR allocator type. &amp;ldquo;RangeAllocator&amp;rdquo; or &amp;ldquo;CloudAllocator&amp;rdquo;&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>For each node pool (VMSS or VMAS), tag &lt;code>{&amp;quot;kubernetesNodeCIDRMaskSize&amp;quot;: &amp;quot;24&amp;quot;}&lt;/code> could be added by demand and its values would be used for new node's CIDR allocation.&lt;/p>
&lt;h2 id="open-questions">Open Questions&lt;/h2>
&lt;p>Q: what would happen if the tag value gets changed after some time?
A: In this case, existing node's nodeCIDR won't be changed, while new nodes&amp;rsquo; CIDR would be allocated with a new mask size.&lt;/p></description></item></channel></rss>