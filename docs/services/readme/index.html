<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.61.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/cloud-provider-azure/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/cloud-provider-azure/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/cloud-provider-azure/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/cloud-provider-azure/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/cloud-provider-azure/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/cloud-provider-azure/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/cloud-provider-azure/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/cloud-provider-azure/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/cloud-provider-azure/favicons/android-192x192.png sizes=192x192><title>Azure LoadBalancer | Cloud Provider Azure</title><meta property="og:title" content="Azure LoadBalancer"><meta property="og:description" content="Azure LoadBalancer basics."><meta property="og:type" content="article"><meta property="og:url" content="https://nilo19.github.io/cloud-provider-azure/docs/services/readme/"><meta property="article:modified_time" content="2020-07-25T13:37:35+08:00"><meta property="og:site_name" content="Cloud Provider Azure"><meta itemprop=name content="Azure LoadBalancer"><meta itemprop=description content="Azure LoadBalancer basics."><meta itemprop=dateModified content="2020-07-25T13:37:35+08:00"><meta itemprop=wordCount content="1214"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Azure LoadBalancer"><meta name=twitter:description content="Azure LoadBalancer basics."><link rel=preload href=/cloud-provider-azure/scss/main.min.125f72e5d5a3aa7d4039aab0c22c38a18b1796f8d41a399c1dbc59e50f290ecd.css as=style><link href=/cloud-provider-azure/scss/main.min.125f72e5d5a3aa7d4039aab0c22c38a18b1796f8d41a399c1dbc59e50f290ecd.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/cloud-provider-azure/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Cloud Provider Azure</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/cloud-provider-azure/install/><span>Installation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/cloud-provider-azure/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/cloud-provider-azure/api/><span>API Reference</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/cloud-provider-azure/example/><span>Example</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/cloud-provider-azure/contribute/><span>Contributing</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/cloud-provider-azure/faq/><span>FAQ</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/cloud-provider-azure/blog/><span>Blog</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/cloud-provider-azure/docs/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Documentation</a></li><ul><li class="collapse show" id=cloud-provider-azure-docs><a class="td-sidebar-link td-sidebar-link__page" id=m-cloud-provider-azure-docs-ccm-cloud-controller-manager href=/cloud-provider-azure/docs/ccm/cloud-controller-manager/>Cloud controller manager</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-cloud-provider-azure-docs-services-readme href=/cloud-provider-azure/docs/services/readme/>Azure LoadBalancer</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/cloud-provider-azure/docs/persistentvolumes/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Persistent Volumes</a></li><ul><li class=collapse id=cloud-provider-azure-docs-persistentvolumes><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/cloud-provider-azure/docs/persistentvolumes/azuredisk/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">AzureDisk</a></li><ul><li class=collapse id=cloud-provider-azure-docs-persistentvolumes-azuredisk><a class="td-sidebar-link td-sidebar-link__page" id=m-cloud-provider-azure-docs-persistentvolumes-azuredisk-issues href=/cloud-provider-azure/docs/persistentvolumes/azuredisk/issues/>Known Issues</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/cloud-provider-azure/docs/persistentvolumes/azurefile/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">AzureFile</a></li><ul><li class=collapse id=cloud-provider-azure-docs-persistentvolumes-azurefile><a class="td-sidebar-link td-sidebar-link__page" id=m-cloud-provider-azure-docs-persistentvolumes-azurefile-issues href=/cloud-provider-azure/docs/persistentvolumes/azurefile/issues/>Known Issues</a></li></ul></ul></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-cloud-provider-azure-docs-permission-azure-permissions href=/cloud-provider-azure/docs/permission/azure-permissions/>Azure Permissions</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-cloud-provider-azure-docs-config-cloud-provider-config href=/cloud-provider-azure/docs/config/cloud-provider-config/>Cloud Provider Config</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-cloud-provider-azure-docs-version-component-versioning href=/cloud-provider-azure/docs/version/component-versioning/>Component Versioning</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-cloud-provider-azure-docs-dep-dependency-management href=/cloud-provider-azure/docs/dep/dependency-management/>Dependencies</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/cloud-provider-azure/docs/e2e/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">E2E tests</a></li><ul><li class=collapse id=cloud-provider-azure-docs-e2e><a class="td-sidebar-link td-sidebar-link__page" id=m-cloud-provider-azure-docs-e2e-e2e-tests-azure href=/cloud-provider-azure/docs/e2e/e2e-tests-azure/>Azure E2E tests</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-cloud-provider-azure-docs-e2e-e2e-tests href=/cloud-provider-azure/docs/e2e/e2e-tests/>Kubernetes E2E tests</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-cloud-provider-azure-docs-release-release-versioning href=/cloud-provider-azure/docs/release/release-versioning/>Release Versioning</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/cloud-provider-azure/docs/howto/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">How to</a></li><ul><li class=collapse id=cloud-provider-azure-docs-howto><a class="td-sidebar-link td-sidebar-link__page" id=m-cloud-provider-azure-docs-howto-using-availability-zones href=/cloud-provider-azure/docs/howto/using-availability-zones/>Availability Zones</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-cloud-provider-azure-docs-howto-using-cross-resource-group-nodes href=/cloud-provider-azure/docs/howto/using-cross-resource-group-nodes/>Cross Resource Group Nodes</a></li></ul></ul></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/kubernetes-sigs/cloud-provider-azure/edit/master/content/en/docs/services/README.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/kubernetes-sigs/cloud-provider-azure/issues/new?title=Azure%20LoadBalancer" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href=https://github.com/kubernetes-sigs/cloud-provider-azure/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#loadbalancer-annotations>LoadBalancer annotations</a><ul><li><a href=#load-balancer-selection-modes>Load balancer selection modes</a></li></ul></li><li><a href=#loadbalancer-skus>LoadBalancer SKUs</a><ul><li><a href=#outbound-connectivity>Outbound connectivity</a></li><li><a href=#standard-loadbalancer>Standard LoadBalancer</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=https://nilo19.github.io/cloud-provider-azure/docs/>Documentation</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://nilo19.github.io/cloud-provider-azure/docs/services/readme/>Azure LoadBalancer</a></li></ol></nav><div class=td-content><h1>Azure LoadBalancer</h1><div class=lead>Azure LoadBalancer basics.</div><p>The way Azure defines a LoadBalancer is different from GCE or AWS. Azure's LB can have multiple frontend IP refs. GCE and AWS only allow one, if you want more, you would need multiple LB's. Since Public IP's are not part of the LB in Azure, an NSG is not part of the LB in Azure either. However, you cannot delete them in parallel, a Public IP can only be deleted after the LB's frontend IP ref is removed.</p><p>The different Azure Resources such as LB, Public IP, and NSG are the same tier of Azure resources and circular dependencies need to be avoided. In another words, they should only depend on service state.</p><p>By default the basic SKU is selected for a load balancer. Services can be annotated to allow auto selection of available load balancers. Service annotations can also be used to provide specific availability sets that host the load balancers. Note that in case of auto selection or specific availability set selection, services are currently not auto-reassigned to an available loadbalancer when the availability set is lost in case of downtime or cluster scale down.</p><h2 id=loadbalancer-annotations>LoadBalancer annotations</h2><p>Below is a list of annotations supported for Kubernetes services with type <code>LoadBalancer</code>:</p><table><thead><tr><th>Annotation</th><th>Value</th><th>Description</th><th>Kubernetes Version</th></tr></thead><tbody><tr><td><code>service.beta.kubernetes.io/azure-load-balancer-internal</code></td><td><code>true</code> or <code>false</code></td><td>Specify whether the load balancer should be internal. It’s defaulting to public if not set.</td><td>v1.10.0 and later</td></tr><tr><td><code>service.beta.kubernetes.io/azure-load-balancer-internal-subnet</code></td><td>Name of the subnet</td><td>Specify which subnet the internal load balancer should be bound to. It’s defaulting to the subnet configured in cloud config file if not set.</td><td>v1.10.0 and later</td></tr><tr><td><code>service.beta.kubernetes.io/azure-load-balancer-mode</code></td><td><code>auto</code>, <code>{name1},{name2}</code></td><td>Specify the Azure load balancer selection algorithm based on availability sets. There are currently three possible load balancer selection modes : default, auto or &ldquo;{name1}, {name2}". This is only working for basic LB (see below for how it works)</td><td>v1.10.0 and later</td></tr><tr><td><code>service.beta.kubernetes.io/azure-dns-label-name</code></td><td>Name of the PIP DNS label</td><td>Specify the DNS label name for the service's public IP address (PIP). If it is set to empty string, DNS in PIP would be deleted. Because of a bug, before v1.15.10/v1.16.7/v1.17.3, the DNS label on PIP would also be deleted if the annotation is not specified.</td><td>v1.15.0 and later</td></tr><tr><td><code>service.beta.kubernetes.io/azure-shared-securityrule</code></td><td><code>true</code> or <code>false</code></td><td>Specify that the service should be exposed using an Azure security rule that may be shared with another service, trading specificity of rules for an increase in the number of services that can be exposed. This relies on the Azure &ldquo;augmented security rules&rdquo; feature.</td><td>v1.10.0 and later</td></tr><tr><td><code>service.beta.kubernetes.io/azure-load-balancer-resource-group</code></td><td>Name of the PIP resource group</td><td>Specify the resource group of the service's PIP that are not in the same resource group as the cluster.</td><td>v1.10.0 and later</td></tr><tr><td><code>service.beta.kubernetes.io/azure-allowed-service-tags</code></td><td>List of allowed service tags</td><td>Specify a list of allowed <a href=https://docs.microsoft.com/en-us/azure/virtual-network/security-overview#service-tags>service tags</a> separated by comma.</td><td>v1.11.0 and later</td></tr><tr><td><code>service.beta.kubernetes.io/azure-load-balancer-tcp-idle-timeout</code></td><td>TCP idle timeouts in minutes</td><td>Specify the time, in minutes, for TCP connection idle timeouts to occur on the load balancer. Default and minimum value is 4. Maximum value is 30. Must be an integer.</td><td>v1.11.4, v1.12.0 and later</td></tr><tr><td><code>service.beta.kubernetes.io/azure-pip-name</code>|Name of PIP</td><td>Specify the PIP that will be applied to load balancer</td><td>v1.16 and later</td><td></td></tr><tr><td><code>service.beta.kubernetes.io/azure-load-balancer-disable-tcp-reset</code>|<code>true</code>|Disable <code>enableTcpReset</code> for SLB</td><td>v1.16-v1.18. The annotation has been deprecated and would be removed in a future release.</td><td></td><td></td></tr></tbody></table><h3 id=load-balancer-selection-modes>Load balancer selection modes</h3><p>There are currently three possible load balancer selection modes :</p><ol><li>Default mode - service has no annotation (&ldquo;service.beta.kubernetes.io/azure-load-balancer-mode&rdquo;). In this case the Loadbalancer of the primary Availability set is selected</li><li>&ldquo;<strong>auto</strong>&rdquo; mode - service is annotated with <strong>auto</strong> value, this when loadbalancer from any availability set is selected which has the minimum rules associated with it.</li><li>&ldquo;{name1}, {name2}&rdquo; mode - this is when the load balancer from the specified availability sets is selected that has the minimum rules associated with it.</li></ol><p>The selection mode for a load balancer only works for Azure's basic SKU (see below) because of the difference in backend pool endpoints:</p><ul><li>Standard SKU supports any virtual machine in a single virtual network, including a mix of virtual machines, availability sets, and virtual machine scale sets. So all the nodes would be added to the same standard LB backend pool with a max size of 1000.</li><li>Basic SKU only supports virtual machines in a single availability set or a virtual machine scale set. Only nodes with the same availability set or virtual machine scale set would be added to the basic LB backend pool.</li></ul><h2 id=loadbalancer-skus>LoadBalancer SKUs</h2><p>Azure cloud provider supports both <code>basic</code> and <code>standard</code> SKU load balancers, which can be set via <code>loadBalancerSku</code> option in <a href=../../config>cloud config file</a>. A list of differences between these two SKUs can be found <a href=https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-standard-overview#why-use-standard-load-balancer>here</a>.</p><blockquote><p>Note that the public IPs used in load balancer frontend configurations should be the same SKU. That is a standard SKU public IP for standard load balancer and a basic SKU public IP for a basic load balancer.</p></blockquote><p>Azure doesn’t support a network interface joining load balancers with different SKUs, hence migration dynamically between them is not supported.</p><blockquote><p>If you do require migration, please delete all services with type <code>LoadBalancer</code> (or change to other type)</p></blockquote><h3 id=outbound-connectivity>Outbound connectivity</h3><p><a href=https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-outbound-connections>Outbound connectivity</a> is also different between the two load balancer SKUs:</p><ul><li><p>For the basic SKU, the outbound connectivity is opened by default. If multiple frontends are set, then the outbound IP is selected randomly (and configurable) from them.</p></li><li><p>For the standard SKU, the outbound connectivity is disabled by default. There are two ways to open the outbound connectivity: use a standard public IP with the standard load balancer or define outbound rules.</p></li></ul><h3 id=standard-loadbalancer>Standard LoadBalancer</h3><p>Because the load balancer in a Kubernetes cluster is managed by the Azure cloud provider and it may change dynamically (e.g. the public load balancer would be deleted if no services defined with type <code>LoadBalancer</code>), <a href=https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-outbound-rules-overview>outbound rules</a> are the recommended path if you want to ensure the outbound connectivity for all nodes.</p><blockquote><p>Especially note:</p><ul><li><p>In the context of outbound connectivity, a single standalone VM, all the VM's in an Availability Set, all the instances in a VMSS behave as a group. This means, if a single VM in an Availability Set is associated with a Standard SKU, all VM instances within this Availability Set now behave by the same rules as if they are associated with Standard SKU, even if an individual instance is not directly associated with it.</p></li><li><p>Public IP's used as instance-level public IP are mutually exclusive with outbound rules.</p></li></ul></blockquote><p>Here is the recommend way to define the <a href=https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-outbound-rules-overview>outbound rules</a> when using separate provisioning tools:</p><ul><li>Create a separate IP (or multiple IPs for scale) in standard SKU for outbound rules. Make use of the <a href=https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-outbound-rules-overview#snatports>allocatedOutboundPorts</a> parameter to allocate sufficient ports for your desired scenario scale.</li><li>Create a separate pool definition for outbound, and ensure all virtual machines or VMSS virtual machines are in this pool. Azure cloud provider will manage the load balancer rules with another pool, so that provisioning tools and the Azure cloud provider won't affect each other.</li><li>Define inbound with load balancing rules and inbound NAT rules as needed, and set <code>disableOutboundSNAT</code> to true on the load balancing rule(s). Don't rely on the side effect from these rules for outbound connectivity. It makes it messier than it needs to be and limits your options. Use inbound NAT rules to create port forwarding mappings for SSH access to the VM's rather than burning public IPs per instance.</li></ul><style>.feedback--answer{display:inline-block}.feedback--answer-no{margin-left:1em}.feedback--response{display:none;margin-top:1em}.feedback--response__visible{display:block}</style><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="feedback--answer feedback--answer-yes">Yes</button>
<button class="feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/USERNAME/REPOSITORY/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/USERNAME/REPOSITORY/issues/new>tell us how we can improve</a>.</p><script>const yesButton=document.querySelector('.feedback--answer-yes');const noButton=document.querySelector('.feedback--answer-no');const yesResponse=document.querySelector('.feedback--response-yes');const noResponse=document.querySelector('.feedback--response-no');const disableButtons=()=>{yesButton.disabled=true;noButton.disabled=true;};const sendFeedback=(value)=>{if(typeof ga!=='function')return;const args={command:'send',hitType:'event',category:'Helpful',action:'click',label:window.location.pathname,value:value};ga(args.command,args.hitType,args.category,args.action,args.label,args.value);};yesButton.addEventListener('click',()=>{yesResponse.classList.add('feedback--response__visible');disableButtons();sendFeedback(1);});noButton.addEventListener('click',()=>{noResponse.classList.add('feedback--response__visible');disableButtons();sendFeedback(0);});</script><br><div class="text-muted mt-5 pt-3 border-top">Last modified July 25, 2020: <a href=https://github.com/kubernetes-sigs/cloud-provider-azure/commit/16a34f7a2bd10bbce31f01c97435754906be160b>Use hugo to generate doc website (16a34f7a)</a></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Google Group" aria-label="Google Group"><a class=text-white target=_blank href=https://groups.google.com/forum/#!forum/kubernetes-sig-cloud-provider><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/kubernetes-sigs/cloud-provider-azure><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2020 The Docsy Authors All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank>Privacy Policy</a></small></div></div></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/cloud-provider-azure/js/main.min.c804b36e9989ce787003fa1ab274ecaebc0c3eb0e2253094a39d5ea77cf46298.js integrity="sha256-yASzbpmJznhwA/oasnTsrrwMPrDiJTCUo51ep3z0Ypg=" crossorigin=anonymous></script></body></html>